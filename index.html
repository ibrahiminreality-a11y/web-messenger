<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ibrahim Messenger</title>

<style>
body { margin:0; font-family: Arial; background:#ece5dd; }
.header { background:#075e54; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; }
.container { padding:15px; }
input { width:100%; padding:10px; margin:8px 0; }
button { width:100%; padding:10px; background:#128c7e; color:white; border:none; margin-top:5px; cursor:pointer; }
.link { text-align:center; margin-top:10px; color:#075e54; cursor:pointer; }
.chat-item { background:white; padding:10px; margin:5px 0; border-radius:5px; cursor:pointer; }
.message { margin:5px 0; padding:8px 12px; border-radius:15px; max-width:70%; word-wrap:break-word; }
.me { background:#dcf8c6; margin-left:auto; }
.other { background:white; }
.hidden { display:none; }
.small { width:auto; padding:5px 10px; font-size:12px; }
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginSection">
<div class="header">Login</div>
<div class="container">
<input type="email" id="loginEmail" placeholder="Email">
<input type="password" id="loginPassword" placeholder="Password">
<button onclick="login()">Login</button>
<div class="link" onclick="showRegister()">Don't have an account? Register</div>
</div>
</div>

<!-- REGISTER -->
<div id="registerSection" class="hidden">
<div class="header">Register</div>
<div class="container">
<input type="text" id="registerName" placeholder="Full Name">
<input type="email" id="registerEmail" placeholder="Email">
<input type="password" id="registerPassword" placeholder="Password">
<button onclick="register()">Create Account</button>
<div class="link" onclick="showLogin()">Already have an account? Login</div>
</div>
</div>

<!-- CHAT LIST -->
<div id="chatListSection" class="hidden">
<div class="header">
<span>Ibrahim Messenger</span>
<div>
<button class="small" onclick="openProfile()">Profile</button>
<button class="small" onclick="logout()">Logout</button>
</div>
</div>
<div class="container">
<button onclick="createChat()">Start New Chat</button>
<div id="chatList"></div>
</div>
</div>

<!-- PROFILE -->
<div id="profileSection" class="hidden">
<div class="header">
<span>Profile</span>
<button class="small" onclick="backToList()">Back</button>
</div>
<div class="container">
<p><b>Name:</b> <span id="profileName"></span></p>
<p><b>Email:</b> <span id="profileEmail"></span></p>
</div>
</div>

<!-- CHAT -->
<div id="chatSection" class="hidden">
<div class="header">
<span id="chatTitle"></span>
<button class="small" onclick="backToList()">Back</button>
</div>
<div class="container" id="messages"></div>
<div class="container">
<input type="text" id="messageInput" placeholder="Type message">
<button onclick="sendMessage()">Send</button>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, doc, setDoc, getDoc, orderBy }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ à¦¤à§‹à¦®à¦¾à¦° Firebase config à¦¬à¦¸à¦¾à¦“ */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentUserName = "";
let currentChatId = null;

/* UI SWITCH */
window.showRegister = () => {
  loginSection.classList.add("hidden");
  registerSection.classList.remove("hidden");
};

window.showLogin = () => {
  registerSection.classList.add("hidden");
  loginSection.classList.remove("hidden");
};

/* LOGIN */
window.login = async () => {
  await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
};

/* REGISTER */
window.register = async () => {
  if (!registerName.value) return alert("Enter name");

  const userCredential = await createUserWithEmailAndPassword(
    auth,
    registerEmail.value,
    registerPassword.value
  );

  await setDoc(doc(db, "users", userCredential.user.uid), {
    name: registerName.value,
    email: registerEmail.value
  });
};

/* LOGOUT */
window.logout = async () => {
  await signOut(auth);
};

/* AUTH STATE */
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) currentUserName = userDoc.data().name;

    loginSection.classList.add("hidden");
    registerSection.classList.add("hidden");
    chatListSection.classList.remove("hidden");
    loadChats();
  } else {
    loginSection.classList.remove("hidden");
    chatListSection.classList.add("hidden");
    profileSection.classList.add("hidden");
    chatSection.classList.add("hidden");
  }
});

/* LOAD CHATS */
async function loadChats() {
  chatList.innerHTML = "";
  const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
  const snapshot = await getDocs(q);

  snapshot.forEach(async (docSnap) => {
    const chat = docSnap.data();
    const otherId = chat.participants.find(id => id !== currentUser.uid);
    const otherDoc = await getDoc(doc(db, "users", otherId));
    const otherName = otherDoc.exists() ? otherDoc.data().name : "User";

    const div = document.createElement("div");
    div.className = "chat-item";
    div.innerHTML = "<b>" + otherName + "</b><br>" + (chat.lastMessage || "");
    div.onclick = () => openChat(docSnap.id, otherName);
    chatList.appendChild(div);
  });
}

/* CREATE CHAT */
window.createChat = async () => {
  const otherEmail = prompt("Enter user email");
  if (!otherEmail) return;

  const usersSnapshot = await getDocs(query(collection(db, "users"), where("email", "==", otherEmail)));
  if (usersSnapshot.empty) return alert("User not found");

  const otherUser = usersSnapshot.docs[0];

  const chatRef = await addDoc(collection(db, "chats"), {
    participants: [currentUser.uid, otherUser.id],
    lastMessage: ""
  });

  openChat(chatRef.id, otherUser.data().name);
};

/* OPEN CHAT */
window.openChat = (chatId, name) => {
  currentChatId = chatId;
  chatTitle.innerText = name;
  chatListSection.classList.add("hidden");
  chatSection.classList.remove("hidden");
  loadMessages();
};

/* LOAD MESSAGES */
function loadMessages() {
  messages.innerHTML = "";

  const q = query(collection(db, "chats", currentChatId, "messages"), orderBy("timestamp"));
  onSnapshot(q, snapshot => {
    messages.innerHTML = "";
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const div = document.createElement("div");
      div.className = "message " + (msg.sender === currentUser.uid ? "me" : "other");
      div.innerText = msg.text;
      messages.appendChild(div);
    });
  });
}

/* SEND MESSAGE */
window.sendMessage = async () => {
  if (!messageInput.value) return;

  await addDoc(collection(db, "chats", currentChatId, "messages"), {
    text: messageInput.value,
    sender: currentUser.uid,
    timestamp: Date.now()
  });

  await setDoc(doc(db, "chats", currentChatId), {
    lastMessage: messageInput.value
  }, { merge:true });

  messageInput.value = "";
};

/* PROFILE */
window.openProfile = () => {
  profileName.innerText = currentUserName;
  profileEmail.innerText = currentUser.email;
  chatListSection.classList.add("hidden");
  profileSection.classList.remove("hidden");
};

window.backToList = () => {
  chatSection.classList.add("hidden");
  profileSection.classList.add("hidden");
  chatListSection.classList.remove("hidden");
};

</script>
</body>
</html>
